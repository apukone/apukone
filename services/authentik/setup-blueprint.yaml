version: 1
metadata:
  name: apukone-setup
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # Groups
  - model: authentik_core.group
    id: group-admins
    identifiers:
      name: Admins
    attrs:
      name: Admins
      users:
        - !Find [authentik_core.user, [username, akadmin]]
  
  - model: authentik_core.user
    identifiers:
      username: akadmin
    attrs:
      email: !Env ADMIN_EMAIL
      name: Admin User

  # Scopes
  - model: authentik_providers_oauth2.scopemapping
    id: scope-groups
    identifiers:
      name: "Scope Groups"
    attrs:
      name: "Scope Groups"
      scope_name: "groups"
      expression: |
        return [group.name for group in user.ak_groups.all()]

  # OpenWebUI
  - model: authentik_providers_oauth2.oauth2provider
    id: provider-openwebui
    identifiers:
      name: OpenWebUI
    attrs:
      name: OpenWebUI
      client_id: !Env OPENWEBUI_OIDC_CLIENT_ID
      client_secret: !Env OPENWEBUI_OIDC_CLIENT_SECRET
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      redirect_uris:
        - matching_mode: strict
          url: !Format ["https://chat.%s/oauth/oidc/callback", !Env BASE_DOMAIN]
        - matching_mode: strict
          url: !Format ["http://chat.%s/oauth/oidc/callback", !Env BASE_DOMAIN]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      property_mappings:
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, "Scope Groups"]]
      sub_mode: hashed_user_id
      issuer_mode: per_provider
      client_type: confidential
      access_token_validity: hours=1
      refresh_token_validity: days=30
      include_claims_in_id_token: true
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]

  - model: authentik_core.application
    id: app-openwebui
    identifiers:
      name: OpenWebUI
    attrs:
      name: OpenWebUI
      slug: openwebui
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, OpenWebUI]]
      meta_launch_url: !Format ["https://chat.%s", !Env BASE_DOMAIN]
      policy_engine_mode: any
      group: Apukone Apps

  # LiteLLM
  - model: authentik_providers_oauth2.oauth2provider
    id: provider-litellm
    identifiers:
      name: LiteLLM
    attrs:
      name: LiteLLM
      client_id: !Env LITELLM_OIDC_CLIENT_ID
      client_secret: !Env LITELLM_OIDC_CLIENT_SECRET
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      redirect_uris:
        - matching_mode: strict
          url: !Format ["https://llm.%s/sso/callback", !Env BASE_DOMAIN]
        - matching_mode: strict
          url: !Format ["http://llm.%s/sso/callback", !Env BASE_DOMAIN]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      property_mappings:
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, "Scope Groups"]]
      sub_mode: user_username
      issuer_mode: global
      client_type: confidential
      access_token_validity: hours=1
      refresh_token_validity: days=30
      include_claims_in_id_token: true
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
  
  - model: authentik_core.application
    id: app-litellm
    identifiers:
      name: LiteLLM
    attrs:
      name: LiteLLM
      slug: litellm
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, LiteLLM]]
      meta_launch_url: !Format ["https://llm.%s", !Env BASE_DOMAIN]
      policy_engine_mode: any
      group: Apukone Apps

  # Windmill
  - model: authentik_providers_oauth2.oauth2provider
    id: provider-windmill
    identifiers:
      name: Windmill
    attrs:
      name: Windmill
      client_id: !Env WINDMILL_OIDC_CLIENT_ID
      client_secret: !Env WINDMILL_OIDC_CLIENT_SECRET
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      redirect_uris:
        - matching_mode: strict
          url: !Format ["https://windmill.%s/user/login_callback/Authentik", !Env BASE_DOMAIN]
        - matching_mode: strict
          url: !Format ["http://windmill.%s/user/login_callback/Authentik", !Env BASE_DOMAIN]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      property_mappings:
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, "Scope Groups"]]
      sub_mode: user_username
      issuer_mode: global
      client_type: confidential
      access_token_validity: hours=1
      refresh_token_validity: days=30
      include_claims_in_id_token: true
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]

  - model: authentik_core.application
    id: app-windmill
    identifiers:
      name: Windmill
    attrs:
      name: Windmill
      slug: windmill
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, Windmill]]
      meta_launch_url: !Format ["https://windmill.%s", !Env BASE_DOMAIN]
      policy_engine_mode: any
      group: Apukone Apps
